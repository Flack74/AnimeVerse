<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AnimeVerse - Watch Anime Online for Free</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/static/css/dark-mode-fix.css">
    <link rel="stylesheet" href="/static/css/styles.css">
    <link rel="stylesheet" href="/static/css/dark-mode-fix.css">
    <script src="/static/js/neon-loader.js"></script>
    <script src="/static/js/simple-theme.js"></script>
    <script src="/static/js/supabase.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'primary': '#6366f1',
                        'secondary': '#ec4899',
                        'accent': '#06b6d4',
                    },
                    fontFamily: {
                        'display': ['Inter', 'system-ui', 'sans-serif'],
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen font-display transition-colors">
    <!-- Header -->
    <header class="bg-white/95 dark:bg-gray-800/95 backdrop-blur-sm shadow-lg sticky top-0 z-50 border-b border-gray-200 dark:border-gray-700 transition-colors">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-8">
                    <div class="text-2xl md:text-3xl font-bold bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent">
                        üå∏ ANIMEVERSE
                    </div>
                    <nav class="hidden lg:flex items-center space-x-2">
                        <a href="/static/browse.html" class="text-gray-700 dark:text-gray-300 hover:text-primary transition-all font-medium px-6 py-2.5 rounded-full hover:bg-primary/10 hover:shadow-sm">Browse</a>
                        <a href="/static/trending.html" class="text-gray-700 hover:text-primary transition-all font-medium px-6 py-2.5 rounded-full hover:bg-primary/10 hover:shadow-sm">Trending</a>
                        <a href="/static/movies.html" class="text-gray-700 hover:text-primary transition-all font-medium px-6 py-2.5 rounded-full hover:bg-primary/10 hover:shadow-sm">Movies</a>
                        <a id="my-list-link" href="/static/my-list.html" class="text-gray-700 hover:text-primary transition-all font-medium px-6 py-2.5 rounded-full hover:bg-primary/10 hover:shadow-sm hidden">
                            <span>üìù</span><span class="ml-1">My List</span>
                        </a>
                        <button onclick="randomAnime()" class="text-gray-700 hover:text-primary transition-all font-medium px-6 py-2.5 rounded-full hover:bg-primary/10 hover:shadow-sm flex items-center space-x-1">
                            <span>üé≤</span><span>Random</span>
                        </button>
                    </nav>
                    <button id="mobile-menu-btn" class="md:hidden p-2 text-gray-600 hover:text-primary transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                    </button>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="relative">
                        <input type="text" id="search-input" placeholder="Search anime..." 
                               class="bg-gray-100 border-0 rounded-full px-6 py-3 pr-12 text-gray-700 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-primary w-64 md:w-80 transition-all"
                               name="search" onkeypress="if(event.key==='Enter') performSearchFromButton()">
                        <button onclick="performSearchFromButton()" class="absolute right-2 top-1/2 transform -translate-y-1/2 p-2 text-gray-400 hover:text-primary transition-colors rounded-full hover:bg-gray-200">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button onclick="toggleTheme()" class="w-10 h-10 rounded-full bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors flex items-center justify-center">
                            <span id="theme-icon">üåô</span>
                        </button>
                        <div id="auth-section">
                            <div id="signed-out" class="flex items-center space-x-3">
                                <a href="/static/login.html" class="text-gray-600 dark:text-gray-300 hover:text-primary transition-colors font-medium px-4 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">Sign In</a>
                                <a href="/static/signup.html" class="bg-gradient-to-r from-primary to-secondary hover:from-indigo-600 hover:to-pink-600 text-white px-6 py-2.5 rounded-full font-medium transition-all shadow-sm hover:shadow-md">Sign Up</a>
                            </div>
                            <div id="signed-in" class="hidden items-center space-x-3">
                                <a href="/static/my-list.html" class="text-gray-600 dark:text-gray-300 hover:text-primary transition-colors font-medium px-3 py-1 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">My List</a>
                                <a href="/static/profile.html" class="w-8 h-8 bg-gradient-to-r from-primary to-secondary rounded-full flex items-center justify-center hover:shadow-lg transition-all" title="My Profile">
                                    <span id="user-avatar" class="text-white text-sm font-bold">U</span>
                                </a>
                                <span id="user-name" class="text-gray-700 dark:text-gray-300 font-medium">User</span>
                                <button onclick="signOut()" class="bg-red-100 dark:bg-red-900 text-red-600 dark:text-red-400 hover:bg-red-200 dark:hover:bg-red-800 px-3 py-1.5 rounded-lg text-sm font-medium transition-colors">Sign Out</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Mobile Menu -->
            <div id="mobile-menu" class="hidden lg:hidden mt-4 pb-4 border-t border-gray-200">
                <nav class="flex flex-col space-y-2 pt-4">
                    <a href="/static/browse.html" class="text-gray-600 hover:text-primary transition-colors font-medium px-4 py-3 rounded-lg hover:bg-gray-100">Browse</a>
                    <a href="/static/trending.html" class="text-gray-600 hover:text-primary transition-colors font-medium px-4 py-3 rounded-lg hover:bg-gray-100">Trending</a>
                    <a href="/static/movies.html" class="text-gray-600 hover:text-primary transition-colors font-medium px-4 py-3 rounded-lg hover:bg-gray-100">Movies</a>
                    <a id="my-list-mobile" href="/static/my-list.html" class="text-gray-600 hover:text-primary transition-colors font-medium px-4 py-3 rounded-lg hover:bg-gray-100 hidden">üìù My List</a>
                    <button onclick="randomAnime()" class="text-left text-gray-600 hover:text-primary transition-colors font-medium px-4 py-3 rounded-lg hover:bg-gray-100">üé≤ Random</button>
                </nav>
            </div>
        </div>
    </header>

    <!-- Spotlight Carousel Section -->
    <section class="relative h-[450px] md:h-[600px] overflow-hidden">
        <div id="huge-carousel" class="relative w-full h-full">
            <!-- Spotlight anime carousel will load here -->
        </div>
        <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-black/30"></div>
        <div class="absolute bottom-0 left-0 right-0 p-8">
            <div class="container mx-auto px-4 sm:px-6">
                <div class="max-w-2xl">
                    <h1 id="carousel-title" class="text-5xl font-bold text-white mb-4">Loading...</h1>
                    <div class="flex items-center space-x-4 mb-4">
                        <span id="carousel-year" class="bg-white/20 backdrop-blur px-3 py-1 rounded-full text-white text-sm">2024</span>
                        <span id="carousel-score" class="bg-yellow-500 text-black px-3 py-1 rounded-full text-sm font-bold">‚≠ê 9.0</span>
                        <span class="bg-blue-500 text-white px-3 py-1 rounded-full text-sm">HD</span>
                    </div>
                    <p id="carousel-description" class="text-white/90 text-lg mb-6 leading-relaxed">Loading description...</p>
                    <div class="flex space-x-4">
                        <button onclick="watchCurrentTrailer()" class="bg-red-600 hover:bg-red-700 text-white px-8 py-3 rounded-lg font-semibold transition-colors flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z"/>
                            </svg>
                            Watch Trailer
                        </button>
                        <button onclick="showCurrentAnimeModal()" class="bg-white/20 backdrop-blur hover:bg-white/30 text-white px-8 py-3 rounded-lg font-semibold transition-colors border border-white/30">
                            More Info
                        </button>
                    </div>
                </div>
                <div class="absolute bottom-8 right-8 flex space-x-2">
                    <button onclick="prevCarouselAnime()" class="p-3 rounded-full bg-white/20 backdrop-blur text-white hover:bg-white/30 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                        </svg>
                    </button>
                    <button onclick="nextCarouselAnime()" class="p-3 rounded-full bg-white/20 backdrop-blur text-white hover:bg-white/30 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                        </svg>
                    </button>
                </div>
                <div id="carousel-indicators" class="absolute bottom-8 left-1/2 transform -translate-x-1/2 flex space-x-2">
                    <!-- Indicators will be generated here -->
                </div>
            </div>
        </div>
    </section>

    <!-- Search Results Section -->
    <section id="search-results-section" class="hidden bg-white shadow-sm border-b fade-in">
        <div class="container mx-auto px-6 py-8">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Search Results</h2>
                <button onclick="clearSearch()" class="text-gray-500 hover:text-gray-700 transition-colors flex items-center space-x-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                    <span>Clear Search</span>
                </button>
            </div>
            <div id="search-results" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4">
                <!-- Search results will appear here -->
            </div>
        </div>
    </section>

    <!-- Main Content -->
    <main class="bg-gray-50 dark:bg-gray-900 transition-colors">
        <div class="container mx-auto px-4 sm:px-6 py-8 sm:py-12">
            <!-- Featured Section -->
            <section class="mb-16">
                <div class="flex items-center justify-between mb-8">
                    <h2 class="text-3xl font-bold text-gray-900 dark:text-gray-100">Featured Anime</h2>
                    <button onclick="loadAllAnime()" class="text-primary hover:text-indigo-600 font-semibold transition-colors">View All ‚Üí</button>
                </div>
                <div id="preview-content" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4">
                    <!-- Featured anime cards will load here -->
                </div>
            </section>

            <!-- Movies Section -->
            <section class="mb-16">
                <div class="flex items-center justify-between mb-8">
                    <h2 class="text-3xl font-bold text-gray-900 dark:text-gray-100">Movies</h2>
                    <a href="/static/movies.html" class="text-primary hover:text-indigo-600 font-semibold transition-colors">View All ‚Üí</a>
                </div>
                <div class="relative">
                    <div id="movies-carousel" class="flex space-x-6 overflow-x-auto scrollbar-hide pb-4">
                        <!-- Movie cards will load here -->
                    </div>
                </div>
            </section>

            <!-- Schedule Section -->
            <section class="mb-16">
                <h2 class="text-3xl font-bold mb-8 text-gray-900 dark:text-gray-100">Airing Schedule</h2>
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6 transition-colors">
                    <div class="flex space-x-4 mb-6 overflow-x-auto scrollbar-hide">
                        <button onclick="loadScheduleDay('today')" class="schedule-day-btn flex-none bg-primary text-white px-4 py-2 rounded-full font-medium">Today</button>
                        <button onclick="loadScheduleDay('monday')" class="schedule-day-btn flex-none bg-gray-100 text-gray-600 px-4 py-2 rounded-full font-medium hover:bg-gray-200">Monday</button>
                        <button onclick="loadScheduleDay('tuesday')" class="schedule-day-btn flex-none bg-gray-100 text-gray-600 px-4 py-2 rounded-full font-medium hover:bg-gray-200">Tuesday</button>
                        <button onclick="loadScheduleDay('wednesday')" class="schedule-day-btn flex-none bg-gray-100 text-gray-600 px-4 py-2 rounded-full font-medium hover:bg-gray-200">Wednesday</button>
                        <button onclick="loadScheduleDay('thursday')" class="schedule-day-btn flex-none bg-gray-100 text-gray-600 px-4 py-2 rounded-full font-medium hover:bg-gray-200">Thursday</button>
                        <button onclick="loadScheduleDay('friday')" class="schedule-day-btn flex-none bg-gray-100 text-gray-600 px-4 py-2 rounded-full font-medium hover:bg-gray-200">Friday</button>
                        <button onclick="loadScheduleDay('saturday')" class="schedule-day-btn flex-none bg-gray-100 text-gray-600 px-4 py-2 rounded-full font-medium hover:bg-gray-200">Saturday</button>
                        <button onclick="loadScheduleDay('sunday')" class="schedule-day-btn flex-none bg-gray-100 text-gray-600 px-4 py-2 rounded-full font-medium hover:bg-gray-200">Sunday</button>
                    </div>
                    <div id="schedule-section" class="space-y-3">
                        <!-- Schedule items will load here -->
                    </div>
                </div>
            </section>



            <!-- Browse Anime Section -->
            <section>
                <div class="flex items-center justify-between mb-8">
                    <h2 class="text-3xl font-bold text-gray-900 dark:text-gray-100">Browse Anime</h2>
                    <div class="flex flex-col sm:flex-row items-start sm:items-center space-y-4 sm:space-y-0 sm:space-x-4">
                        <button id="browse-all-btn" onclick="browseWithFilters()" class="bg-gradient-to-r from-primary to-secondary text-white px-6 py-3 rounded-lg font-medium hover:shadow-lg transition-all">
                            Browse All ‚Üí
                        </button>
                        <div class="flex flex-wrap gap-2 sm:gap-3">
                            <select id="genre-filter" class="bg-white border border-gray-300 rounded-lg px-3 py-2 text-gray-700 focus:outline-none focus:ring-2 focus:ring-primary text-sm">
                                <option value="">Genres</option>
                                <option value="Action">Action</option>
                                <option value="Adventure">Adventure</option>
                                <option value="Comedy">Comedy</option>
                                <option value="Drama">Drama</option>
                                <option value="Fantasy">Fantasy</option>
                                <option value="Romance">Romance</option>
                                <option value="Supernatural">Supernatural</option>
                            </select>
                            <select id="year-filter" class="bg-white border border-gray-300 rounded-lg px-3 py-2 text-gray-700 focus:outline-none focus:ring-2 focus:ring-primary text-sm">
                                <option value="">Years</option>
                                <option value="2024">2024</option>
                                <option value="2023">2023</option>
                                <option value="2022">2022</option>
                                <option value="2021">2021</option>
                                <option value="2020">2020</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div id="main-content" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4">
                    <!-- Anime content will load here -->
                </div>
            </section>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-900 text-white py-12">
        <div class="container mx-auto px-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                <div class="col-span-1 md:col-span-2">
                    <div class="text-3xl font-bold bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent mb-4">
                        üå∏ ANIMEVERSE
                    </div>
                    <p class="text-gray-400 mb-4 max-w-md">
                        Your ultimate destination for watching anime online. Discover thousands of anime series and movies with high-quality streaming.
                    </p>
                </div>
                <div>
                    <h3 class="text-lg font-semibold mb-4">Quick Links</h3>
                    <ul class="space-y-2">
                        <li><a href="/static/browse.html" class="text-gray-400 hover:text-white transition-colors">Browse Anime</a></li>
                        <li><a href="/static/trending.html" class="text-gray-400 hover:text-white transition-colors">Trending</a></li>
                        <li><a href="/static/top-rated.html" class="text-gray-400 hover:text-white transition-colors">Top Rated</a></li>
                    </ul>
                </div>
                <div>
                    <h3 class="text-lg font-semibold mb-4">Support</h3>
                    <ul class="space-y-2">
                        <li><a href="#" class="text-gray-400 hover:text-white transition-colors">Help Center</a></li>
                        <li><a href="#" class="text-gray-400 hover:text-white transition-colors">Contact Us</a></li>
                        <li><a href="#" class="text-gray-400 hover:text-white transition-colors">Privacy Policy</a></li>
                    </ul>
                </div>
            </div>
            <div class="border-t border-gray-800 mt-8 pt-8 flex flex-col md:flex-row justify-between items-center">
                <div class="text-gray-400 text-sm mb-4 md:mb-0">
                    ¬© 2025 AnimeVerse. All rights reserved.
                </div>
                <div class="text-gray-400 text-sm flex items-center">
                    Built with <span class="text-red-500 mx-1">‚ù§Ô∏è</span> by <span class="text-white font-medium ml-1">Flack</span>
                </div>
            </div>
        </div>
    </footer>

    <!-- Anime Detail Modal -->
    <div id="anime-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-3xl max-w-6xl w-full mx-4 max-h-[90vh] overflow-y-auto shadow-2xl">
            <div id="modal-content" class="p-8">
                <!-- Modal content will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Main JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üå∏ AnimeVerse Loading...');
            
            // Load dynamic spotlight carousel with caching
            try {
                const cacheKey = 'carousel_data';
                const cacheExpiry = 'carousel_expiry';
                const now = Date.now();
                const cached = localStorage.getItem(cacheKey);
                const expiry = localStorage.getItem(cacheExpiry);
                
                // Use cache if valid (30 minutes)
                if (cached && expiry && now < parseInt(expiry)) {
                    carouselAnimes = JSON.parse(cached);
                    console.log(`üíæ Carousel loaded from cache: ${carouselAnimes.length} anime`);
                    
                    const carousel = document.getElementById('huge-carousel');
                    if (carousel && carouselAnimes[0]) {
                        carousel.style.backgroundImage = `url('${carouselAnimes[0].bannerUrl || carouselAnimes[0].imageUrl}')`;
                        carousel.style.backgroundSize = 'cover';
                        carousel.style.backgroundPosition = 'center';
                    }
                    
                    updateCarouselDisplay();
                    carouselInterval = setInterval(nextCarouselAnime, 6000);
                } else {
                    // Fetch fresh data
                    const response = await fetch('https://graphql.anilist.co', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            query: `{
                                Page(page: 1, perPage: 8) {
                                    media(type: ANIME, sort: [TRENDING_DESC, SCORE_DESC], status: RELEASING) {
                                        id
                                        title { romaji english }
                                        description(asHtml: false)
                                        coverImage { extraLarge large }
                                        bannerImage
                                        averageScore
                                        startDate { year }
                                        format
                                        status
                                        genres
                                    }
                                }
                            }`
                        })
                    });
                    
                    const anilistData = await response.json();
                    
                    if (anilistData.data?.Page?.media) {
                        carouselAnimes = anilistData.data.Page.media.map(anime => ({
                            id: anime.id,
                            name: anime.title.english || anime.title.romaji,
                            title: anime.title.english || anime.title.romaji,
                            description: anime.description,
                            imageUrl: anime.coverImage.extraLarge || anime.coverImage.large,
                            bannerUrl: anime.bannerImage,
                            score: anime.averageScore ? anime.averageScore / 10 : null,
                            year: anime.startDate?.year,
                            type: anime.format,
                            status: anime.status,
                            genre: anime.genres
                        }));
                        
                        // Cache for 30 minutes
                        localStorage.setItem(cacheKey, JSON.stringify(carouselAnimes));
                        localStorage.setItem(cacheExpiry, (now + 30 * 60 * 1000).toString());
                        
                        console.log(`üé† Carousel loaded fresh: ${carouselAnimes.length} anime`);
                        
                        const carousel = document.getElementById('huge-carousel');
                        if (carousel && carouselAnimes[0]) {
                            carousel.style.backgroundImage = `url('${carouselAnimes[0].bannerUrl || carouselAnimes[0].imageUrl}')`;
                            carousel.style.backgroundSize = 'cover';
                            carousel.style.backgroundPosition = 'center';
                        }
                        
                        updateCarouselDisplay();
                        carouselInterval = setInterval(nextCarouselAnime, 6000);
                    } else {
                        throw new Error('No carousel data');
                    }
                }
            } catch (error) {
                console.error('Carousel error:', error);
                document.getElementById('carousel-title').textContent = 'Welcome to AnimeVerse';
                document.getElementById('carousel-description').textContent = 'Your ultimate anime discovery platform.';
                document.getElementById('carousel-year').textContent = '2025';
                document.getElementById('carousel-score').textContent = '‚≠ê 9.0';
            }
            
            // Load initial content
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `
                <div class="col-span-full text-center py-16">
                    <div class="text-6xl mb-4">üå∏</div>
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">Ready to Explore?</h3>
                    <p class="text-gray-600 mb-6">Browse thousands of anime or discover what's trending</p>
                    <div class="flex flex-col sm:flex-row gap-4 justify-center">
                        <button onclick="loadAllAnime()" class="bg-gradient-to-r from-primary to-secondary text-white px-8 py-3 rounded-full font-semibold hover:shadow-lg transition-all">
                            Browse All Anime
                        </button>
                        <a href="/static/trending.html" class="bg-gradient-to-r from-pink-500 to-purple-600 text-white px-8 py-3 rounded-full font-semibold hover:shadow-lg transition-all no-underline inline-block">
                            üî• Trending Now
                        </a>
                    </div>
                </div>`;
            
            // Load featured anime (top-rated mixed)
            try {
                const featuredResponse = await fetch('/api/animes/top-rated-mixed');
                const featuredData = await featuredResponse.json();
                
                if (featuredData.success && featuredData.data) {
                    renderFeaturedAnime(featuredData.data.slice(0, 12));
                } else {
                    throw new Error('No featured data');
                }
            } catch (error) {
                console.error('Featured anime error:', error);
                document.getElementById('preview-content').innerHTML = '<div class="col-span-full text-center py-8 text-gray-500">Failed to load featured anime</div>';
            }
            
            // Load movies from AniList
            try {
                const moviesResponse = await fetch('https://graphql.anilist.co', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        query: `{
                            Page(page: 1, perPage: 8) {
                                media(type: ANIME, format: MOVIE, sort: POPULARITY_DESC) {
                                    title { romaji english }
                                    coverImage { large }
                                    averageScore
                                    startDate { year }
                                }
                            }
                        }`
                    })
                });
                
                const moviesData = await moviesResponse.json();
                
                if (moviesData.data?.Page?.media) {
                    let moviesHtml = '';
                    moviesData.data.Page.media.forEach((movie, index) => {
                        const title = movie.title.english || movie.title.romaji;
                        const score = movie.averageScore ? (movie.averageScore / 10).toFixed(1) : 'N/A';
                        const year = movie.startDate?.year || 'Unknown';
                        
                        moviesHtml += `
                            <div onclick="showAnimeModal('${title}')" class="flex-shrink-0 w-48 bg-white rounded-xl shadow-lg overflow-hidden hover:shadow-xl transition-shadow anime-card cursor-pointer">
                                <div class="relative">
                                    <img src="${movie.coverImage.large}" alt="${title}" class="w-full h-64 object-cover">
                                    <div class="absolute top-2 left-2 bg-black/70 text-white px-2 py-1 rounded text-xs font-bold">
                                        ${String(index + 1).padStart(2, '0')}
                                    </div>
                                    <div class="absolute top-2 right-2 bg-yellow-500 text-black px-2 py-1 rounded text-xs font-bold">
                                        ‚≠ê ${score}
                                    </div>
                                </div>
                                <div class="p-4">
                                    <h3 class="font-semibold text-gray-900 text-sm mb-1 truncate">${title}</h3>
                                    <p class="text-gray-500 text-xs">${year} ‚Ä¢ Movie</p>
                                </div>
                            </div>`;
                    });
                    document.getElementById('movies-carousel').innerHTML = moviesHtml;
                }
            } catch (error) {
                console.error('Movies error:', error);
                document.getElementById('movies-carousel').innerHTML = '<div class="text-center py-8 text-gray-500">Failed to load movies</div>';
            }
            
            // Load airing schedule
            loadAiringSchedule();
            
            // Setup search input listener
            const searchInput = document.getElementById('search-input');
            if (searchInput) {
                searchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        performSearchFromButton();
                    }
                });
            }
            

            
            // Monitor auth state changes for featured anime
            let lastAuthState = null;
            setInterval(() => {
                const currentAuthState = window.authManager?.isAuthenticated() || false;
                if (currentAuthState !== lastAuthState) {
                    console.log('üîÑ Auth state changed on home page, refreshing featured anime...');
                    // Re-render featured anime with updated auth state
                    const previewContent = document.getElementById('preview-content');
                    if (previewContent && previewContent.innerHTML.includes('TOP RATED')) {
                        // Reload featured anime to show/hide Add to List buttons
                        fetch('/api/animes/top-rated-mixed')
                        .then(response => response.json())
                        .then(data => {
                            if (data.success && data.data) {
                                renderFeaturedAnime(data.data.slice(0, 12));
                            }
                        })
                        .catch(error => console.log('Could not refresh featured anime:', error));
                    }
                    lastAuthState = currentAuthState;
                }
            }, 1000);
            
            console.log('‚úÖ AnimeVerse Ready!');
        });
        

        

        
        // Remove this function - use global signOut from supabase.js
        
        function renderFeaturedAnime(animes) {
            const html = animes.map(anime => `
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden hover:shadow-xl transition-shadow anime-card">
                    <div class="relative" onclick="showAnimeModal('${anime.name}')" style="cursor: pointer;">
                        <img src="${anime.imageUrl || 'https://via.placeholder.com/300x400'}" alt="${anime.name}" class="w-full h-64 object-cover">
                        <div class="absolute top-2 right-2 bg-yellow-500 text-black px-2 py-1 rounded text-xs font-bold">
                            ‚≠ê ${anime.score ? anime.score.toFixed(1) : 'N/A'}
                        </div>
                        <div class="absolute top-2 left-2 bg-green-500 text-white px-2 py-1 rounded text-xs font-bold">
                            üèÜ TOP RATED
                        </div>
                    </div>
                    <div class="p-4">
                        <h3 class="font-semibold text-gray-900 dark:text-gray-100 text-sm mb-1 truncate">${anime.name}</h3>
                        <p class="text-gray-500 dark:text-gray-400 text-xs mb-2">${anime.year || 'Unknown'} ‚Ä¢ ${anime.type || 'TV'}</p>
                        ${anime.genre ? `<div class="flex flex-wrap gap-1">${anime.genre.slice(0, 3).map(g => `<span class="bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 px-2 py-0.5 rounded text-xs">${g}</span>`).join('')}</div>` : ''}
                    </div>
                </div>
            `).join('');
            
            document.getElementById('preview-content').innerHTML = html;
        }
        
        // Carousel functionality
        let currentCarouselIndex = 0;
        let carouselAnimes = [];
        let carouselInterval;
        
        function nextCarouselAnime() {
            if (carouselAnimes.length === 0) return;
            currentCarouselIndex = (currentCarouselIndex + 1) % carouselAnimes.length;
            updateCarouselDisplay();
        }
        
        function prevCarouselAnime() {
            if (carouselAnimes.length === 0) return;
            currentCarouselIndex = currentCarouselIndex === 0 ? carouselAnimes.length - 1 : currentCarouselIndex - 1;
            updateCarouselDisplay();
        }
        
        async function updateCarouselDisplay() {
            const anime = carouselAnimes[currentCarouselIndex];
            if (!anime) return;
            
            const carousel = document.getElementById('huge-carousel');
            if (carousel) {
                let bannerUrl = anime.bannerUrl || anime.imageUrl;
                
                // Always try to get high quality images for carousel
                try {
                    const response = await fetch(`/api/anime/upgrade-images?name=${encodeURIComponent(anime.name || anime.title)}&id=${anime.id || ''}&currentBanner=${encodeURIComponent(bannerUrl || '')}&currentCover=${encodeURIComponent(anime.imageUrl || '')}`);
                    const data = await response.json();
                    
                    if (data.success && data.banner) {
                        bannerUrl = data.banner;
                        // Update anime object for future use
                        anime.bannerUrl = data.banner;
                        if (data.cover) anime.imageUrl = data.cover;
                    }
                } catch (error) {
                    console.log('Could not upgrade image quality:', error);
                }
                
                carousel.style.backgroundImage = `url('${bannerUrl}')`;
                carousel.style.backgroundSize = 'cover';
                carousel.style.backgroundPosition = 'center';
            }
            
            document.getElementById('carousel-title').textContent = anime.name || anime.title;
            document.getElementById('carousel-year').textContent = anime.year || '2024';
            document.getElementById('carousel-score').textContent = `‚≠ê ${anime.score ? anime.score.toFixed(1) : '9.0'}`;
            const cleanDescription = (anime.description || 'Discover amazing anime stories.')
                .replace(/<[^>]*>/g, '') // Remove HTML tags
                .replace(/&[^;]+;/g, ' ') // Remove HTML entities
                .substring(0, 200) + '...';
            document.getElementById('carousel-description').textContent = cleanDescription;
        }
        
        function isLowQualityImage(imageUrl) {
            if (!imageUrl) return true;
            // Check for common low quality indicators
            return imageUrl.includes('placeholder') || 
                   imageUrl.includes('small') || 
                   imageUrl.includes('thumb') ||
                   imageUrl.includes('150x') ||
                   imageUrl.includes('300x');
        }
        
        async function getHighQualityImages(animeName) {
            const response = await fetch(`/api/anime/hq-images?name=${encodeURIComponent(animeName)}`);
            const data = await response.json();
            
            if (data.success) {
                return {
                    cover: data.cover,
                    banner: data.banner
                };
            }
            throw new Error('No high quality images found');
        }
        
        function watchCurrentTrailer() {
            const anime = carouselAnimes[currentCarouselIndex];
            if (anime) {
                const searchQuery = encodeURIComponent((anime.name || anime.title) + ' anime trailer');
                window.open(`https://www.youtube.com/results?search_query=${searchQuery}`, '_blank');
            }
        }
        
        function showCurrentAnimeModal() {
            const anime = carouselAnimes[currentCarouselIndex];
            if (anime) {
                showAnimeModal(anime.name || anime.title);
            }
        }
        
        // Search functionality
        function performSearchFromButton() {
            const searchInput = document.getElementById('search-input');
            if (searchInput && searchInput.value.trim()) {
                performSearch(searchInput.value.trim());
            }
        }
        
        function performSearch(query) {
            const searchResultsSection = document.getElementById('search-results-section');
            const searchResults = document.getElementById('search-results');
            
            if (!searchResultsSection || !searchResults) return;
            
            showNeonLoader('search-results', 'Searching anime...');
            searchResultsSection.classList.remove('hidden');
            searchResultsSection.scrollIntoView({ behavior: 'smooth' });
            
            // Use advanced search API with ranking
            fetch(`/api/animes/search?q=${encodeURIComponent(query)}&limit=50`, {
                headers: { 
                    'Accept': 'application/json',
                    'HX-Request': 'true'
                }
            })
            .then(response => {
                if (response.status === 429) {
                    throw new Error('Rate limit exceeded. Please wait a moment.');
                }
                return response.json();
            })
            .then(data => {
                if (data.success && data.data) {
                    renderSearchResults(data.data);
                } else {
                    searchResults.innerHTML = '<div class="col-span-full text-center py-8 text-gray-500">No anime found for your search.</div>';
                }
            })
            .catch(error => {
                console.error('Search error:', error);
                searchResults.innerHTML = `<div class="col-span-full text-center py-8 text-red-500">${error.message || 'Search failed. Please try again.'}</div>`;
            });
        }
        
        function renderSearchResults(animes) {
            const searchResults = document.getElementById('search-results');
            
            if (animes.length === 0) {
                searchResults.innerHTML = '<div class="col-span-full text-center py-8 text-gray-500">No anime found.</div>';
                return;
            }
            
            const html = animes.map(anime => `
                <div onclick="showAnimeModal('${anime.name}')" class="bg-white rounded-xl shadow-lg overflow-hidden hover:shadow-xl transition-shadow anime-card cursor-pointer">
                    <div class="relative">
                        <img src="${anime.imageUrl || 'https://via.placeholder.com/300x400'}" alt="${anime.name}" class="w-full h-64 object-cover">
                        <div class="absolute top-2 right-2 bg-yellow-500 text-black px-2 py-1 rounded text-xs font-bold">
                            ‚≠ê ${anime.score || 'N/A'}
                        </div>
                        ${anime.type === 'Movie' ? '<div class="absolute bottom-2 right-2 bg-red-500 text-white px-2 py-1 rounded text-xs font-bold">üéå MOVIE</div>' : ''}
                    </div>
                    <div class="p-4">
                        <h3 class="font-semibold text-gray-900 text-sm mb-1 truncate">${anime.name}</h3>
                        <p class="text-gray-500 text-xs">${anime.year || 'Unknown'} ‚Ä¢ ${anime.type || 'TV'}</p>
                        ${anime.genre ? `<div class="flex flex-wrap gap-1 mt-2">${anime.genre.slice(0, 2).map(g => `<span class="bg-primary/10 text-primary px-2 py-0.5 rounded text-xs">${g}</span>`).join('')}</div>` : ''}
                    </div>
                </div>
            `).join('');
            
            searchResults.innerHTML = html;
        }
        
        function clearSearch() {
            const searchInput = document.getElementById('search-input');
            const searchResultsSection = document.getElementById('search-results-section');
            
            if (searchInput) searchInput.value = '';
            if (searchResultsSection) searchResultsSection.classList.add('hidden');
        }
        
        // Anime modal - redirect to detailed page
        function showAnimeModal(animeName) {
            window.location.href = `/static/anime-detail.html?name=${encodeURIComponent(animeName)}`;
        }
        
        function closeModal() {
            const modal = document.getElementById('anime-modal');
            if (modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        }
        
        function watchTrailer(animeName) {
            const searchQuery = encodeURIComponent(animeName + ' anime trailer');
            window.open(`https://www.youtube.com/results?search_query=${searchQuery}`, '_blank');
        }
        
        // Movies view all
        function loadAllMovies() {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = '<div class="col-span-full text-center py-20"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"></div><p class="text-gray-600">Loading movies...</p></div>';
            
            fetch('/api/animes/filter?type=Movie&limit=100', {
                headers: { 'HX-Request': 'true' }
            })
            .then(response => response.text())
            .then(html => {
                mainContent.innerHTML = html;
                document.querySelector('h2').textContent = 'All Movies';
                mainContent.scrollIntoView({ behavior: 'smooth' });
            })
            .catch(error => {
                console.error('Error loading movies:', error);
                mainContent.innerHTML = '<div class="col-span-full text-center py-20 text-red-500">Failed to load movies</div>';
            });
        }
        
        // Browse with filters function
        function browseWithFilters() {
            const genre = document.getElementById('genre-filter').value;
            const year = document.getElementById('year-filter').value;
            
            let url = '/static/browse.html';
            const params = new URLSearchParams();
            
            if (genre) params.append('genre', genre);
            if (year) params.append('year', year);
            
            if (params.toString()) {
                url += '?' + params.toString();
            }
            
            window.location.href = url;
        }
        
        // Global functions
        function loadAllAnime() {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = '<div class="col-span-full text-center py-20"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"></div><p class="text-gray-600">Loading anime...</p></div>';
            
            currentPage = 1;
            
            fetch('/api/animes?limit=50&offset=0', {
                headers: { 'HX-Request': 'true' }
            })
            .then(response => response.text())
            .then(html => {
                mainContent.innerHTML = html + `
                    <div id="load-more-container" class="col-span-full text-center py-8">
                        <button id="load-more-btn" onclick="loadMoreAnime()" class="bg-primary hover:bg-indigo-600 text-white px-8 py-3 rounded-lg font-semibold transition-colors">
                            Load More Anime (100 more)
                        </button>
                    </div>`;
            })
            .catch(error => {
                console.error('Error loading anime:', error);
                mainContent.innerHTML = '<div class="col-span-full text-center py-20 text-red-500">Failed to load anime. Please try again.</div>';
            });
        }
        
        let currentPage = 1;
        
        function loadMoreAnime() {
            const loadBtn = document.getElementById('load-more-btn');
            const loadMoreContainer = document.getElementById('load-more-container');
            
            if (!loadBtn || !loadMoreContainer) return;
            
            loadBtn.textContent = 'Loading...';
            loadBtn.disabled = true;
            
            const offset = currentPage * 50;
            
            fetch(`/api/animes?limit=100&offset=${offset}`, {
                headers: { 'HX-Request': 'true' }
            })
            .then(response => response.text())
            .then(html => {
                const mainContent = document.getElementById('main-content');
                loadMoreContainer.remove();
                
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                
                while (tempDiv.firstChild) {
                    mainContent.appendChild(tempDiv.firstChild);
                }
                
                currentPage += 2;
                
                mainContent.innerHTML += `
                    <div id="load-more-container" class="col-span-full text-center py-8">
                        <button id="load-more-btn" onclick="loadMoreAnime()" class="bg-primary hover:bg-indigo-600 text-white px-8 py-3 rounded-lg font-semibold transition-colors">
                            Load More Anime (100 more)
                        </button>
                    </div>`;
            })
            .catch(error => {
                console.error('Error loading more anime:', error);
                loadBtn.textContent = 'Load More Anime (100 more)';
                loadBtn.disabled = false;
            });
        }
        function loadMoreAnime() {
            currentPage++;
            const loadBtn = event.target;
            loadBtn.textContent = 'Loading...';
            loadBtn.disabled = true;
            
            fetch(`/api/animes?limit=50&offset=${(currentPage-1)*50}`, {
                headers: { 'HX-Request': 'true' }
            })
            .then(response => response.text())
            .then(html => {
                const mainContent = document.getElementById('main-content');
                const loadMoreContainer = loadBtn.parentElement;
                loadMoreContainer.remove();
                mainContent.innerHTML += html + `
                    <div class="col-span-full text-center py-8">
                        <button onclick="loadMoreAnime()" class="bg-primary hover:bg-indigo-600 text-white px-8 py-3 rounded-lg font-semibold transition-colors">
                            Load More Anime
                        </button>
                    </div>`;
            })
            .catch(error => {
                console.error('Error loading more anime:', error);
                loadBtn.textContent = 'Load More Anime';
                loadBtn.disabled = false;
            });
        }
        
        function randomAnime() {
            fetch('/api/animes/random')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.data) {
                    window.location.href = `/static/anime-detail.html?name=${encodeURIComponent(data.data.name)}`;
                } else {
                    alert('No random anime found');
                }
            })
            .catch(error => {
                console.error('Random anime error:', error);
                alert('Failed to get random anime');
            });
        }
        
        // Load airing schedule
        async function loadAiringSchedule() {
            try {
                const response = await fetch('https://graphql.anilist.co', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        query: `{
                            Page(page: 1, perPage: 8) {
                                airingSchedules(sort: TIME, airingAt_greater: ${Math.floor(Date.now() / 1000)}) {
                                    airingAt
                                    episode
                                    media {
                                        title { romaji english }
                                        coverImage { medium }
                                    }
                                }
                            }
                        }`
                    })
                });
                
                const data = await response.json();
                
                if (data.data?.Page?.airingSchedules) {
                    let scheduleHtml = '';
                    data.data.Page.airingSchedules.slice(0, 6).forEach(schedule => {
                        const title = schedule.media.title.english || schedule.media.title.romaji;
                        const airTime = new Date(schedule.airingAt * 1000);
                        const timeStr = airTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                        
                        scheduleHtml += `
                            <div class="flex items-center justify-between p-4 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-xl transition-colors border-l-4 border-primary">
                                <div class="flex items-center space-x-4">
                                    <img src="${schedule.media.coverImage.medium}" alt="${title}" class="w-12 h-16 object-cover rounded-lg">
                                    <div class="min-w-0 flex-1">
                                        <h3 class="font-semibold text-gray-800 dark:text-gray-200 text-sm truncate">${title}</h3>
                                        <p class="text-gray-500 dark:text-gray-400 text-xs">Episode ${schedule.episode}</p>
                                    </div>
                                </div>
                                <span class="bg-gradient-to-r from-primary to-secondary text-white px-3 py-1 rounded-full text-xs font-medium whitespace-nowrap">${timeStr}</span>
                            </div>`;
                    });
                    document.getElementById('schedule-section').innerHTML = scheduleHtml;
                } else {
                    document.getElementById('schedule-section').innerHTML = '<div class="text-center py-8 text-gray-500">No upcoming anime today</div>';
                }
            } catch (error) {
                console.error('Schedule error:', error);
                document.getElementById('schedule-section').innerHTML = '<div class="text-center py-8 text-gray-500">Unable to load schedule</div>';
            }
        }
        
        // Schedule day buttons
        function loadScheduleDay(day) {
            document.querySelectorAll('.schedule-day-btn').forEach(btn => {
                btn.classList.remove('bg-primary', 'text-white');
                btn.classList.add('bg-gray-100', 'text-gray-600');
            });
            event.target.classList.remove('bg-gray-100', 'text-gray-600');
            event.target.classList.add('bg-primary', 'text-white');
            
            loadScheduleByDay(day);
        }
        
        async function loadScheduleByDay(day) {
            const dayMap = {
                'today': 0, 'monday': 1, 'tuesday': 2, 'wednesday': 3,
                'thursday': 4, 'friday': 5, 'saturday': 6, 'sunday': 0
            };
            
            const targetDay = dayMap[day] || 0;
            const now = new Date();
            const startOfDay = new Date(now.setDate(now.getDate() - now.getDay() + targetDay));
            startOfDay.setHours(0, 0, 0, 0);
            const endOfDay = new Date(startOfDay);
            endOfDay.setHours(23, 59, 59, 999);
            
            try {
                const response = await fetch('https://graphql.anilist.co', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        query: `{
                            Page(page: 1, perPage: 10) {
                                airingSchedules(
                                    sort: TIME
                                    airingAt_greater: ${Math.floor(startOfDay.getTime() / 1000)}
                                    airingAt_lesser: ${Math.floor(endOfDay.getTime() / 1000)}
                                ) {
                                    airingAt
                                    episode
                                    media {
                                        title { romaji english }
                                        coverImage { medium }
                                    }
                                }
                            }
                        }`
                    })
                });
                
                const data = await response.json();
                
                if (data.data?.Page?.airingSchedules?.length) {
                    let scheduleHtml = '';
                    data.data.Page.airingSchedules.forEach(schedule => {
                        const title = schedule.media.title.english || schedule.media.title.romaji;
                        const airTime = new Date(schedule.airingAt * 1000);
                        const timeStr = airTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                        
                        scheduleHtml += `
                            <div class="flex items-center justify-between p-4 hover:bg-gray-50 rounded-xl transition-colors border-l-4 border-primary">
                                <div class="flex items-center space-x-4">
                                    <img src="${schedule.media.coverImage.medium}" alt="${title}" class="w-12 h-16 object-cover rounded-lg">
                                    <div class="min-w-0 flex-1">
                                        <h3 class="font-semibold text-gray-800 text-sm truncate">${title}</h3>
                                        <p class="text-gray-500 text-xs">Episode ${schedule.episode}</p>
                                    </div>
                                </div>
                                <span class="bg-gradient-to-r from-primary to-secondary text-white px-3 py-1 rounded-full text-xs font-medium whitespace-nowrap">${timeStr}</span>
                            </div>`;
                    });
                    document.getElementById('schedule-section').innerHTML = scheduleHtml;
                } else {
                    document.getElementById('schedule-section').innerHTML = `<div class="text-center py-8 text-gray-500"><p>No anime airing on ${day}</p></div>`;
                }
            } catch (error) {
                console.error('Schedule error:', error);
                document.getElementById('schedule-section').innerHTML = '<div class="text-center py-8 text-gray-500">Unable to load schedule</div>';
            }
        }
    </script>
</body>
</html>